<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sy.localMsg.repo.mapper.LocalMsgMapper">

    <resultMap id="ConfigResultMap" type="com.sy.localMsg.repo.LocalMessagePO">
        <id column="id" property="id"/>
        <result property="gmtCreate" column="gmt_create"/>
        <result property="gmtModified" column="gmt_modified"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="bizCode" column="biz_code"/>
        <result property="reqSnapshot" column="req_snapshot"/>
        <result property="status" column="status"/>
        <result property="maxRetryTimes" column="max_retry_times"/>
        <result property="nextRetryTime" column="next_retry_time"/>
        <result property="retryTimes" column="retry_times"/>
        <result property="failReason" column="fail_reason"/>
    </resultMap>

    <sql id="result_cols">
        id, gmt_create, gmt_modified, deleted_at, biz_code, req_snapshot, status, max_retry_times, next_retry_time, retry_times, fail_reason
    </sql>

    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO local_message (req_snapshot, status, next_retry_time, retry_times, max_retry_times, fail_reason, biz_code)
        VALUES (#{reqSnapshot}, #{status}, #{nextRetryTime}, #{retryTimes}, #{maxRetryTimes}, #{failReason}, #{bizCode})
    </insert>
    <update id="updateById">
        UPDATE local_message
        <set>
            <if test="reqSnapshot != null and reqSnapshot != ''">req_snapshot = #{reqSnapshot},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="nextRetryTime != null">next_retry_time = #{nextRetryTime},</if>
            <if test="retryTimes != null">retry_times = #{retryTimes},</if>
            <if test="maxRetryTimes != null">max_retry_times = #{maxRetryTimes},</if>
            <if test="failReason != null and failReason != ''">fail_reason = #{failReason},</if>
            <if test="deletedAt != null">deleted_at = #{deletedAt},</if>
        </set>
        WHERE id = #{id}
        AND deleted_at = 0
    </update>
    <select id="loadWaitRetryRecords" resultType="com.sy.localMsg.repo.LocalMessagePO">
        SELECT
        <include refid="result_cols"/>
        FROM local_message
        WHERE status IN
        <foreach collection="status" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND next_retry_time &lt; #{nextRetryTime}
        AND retry_times &lt; max_retry_times
        AND gmt_create &lt; DATE_SUB(NOW(), INTERVAL #{retryIntervalMinutes} MINUTE)
        AND deleted_at = 0
    </select>

</mapper>

